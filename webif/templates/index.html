{% extends "base_plugin.html" %}

{% set logo_frame = false %}
{% set use_bodytabs = true %}
{% set tabcount = 3 %}
{% set tab1title = _('Items') %}
{% set tab2title = _('JSON Data') %}
{% set tab3title = _('Tester') %}

{% set start_tab = 2 %}

{% set json_data = p._get_all_data_for_webif() %}
{% set item_data = p._items %}

{% block pluginscripts %}
<link rel="stylesheet" href="static/leaflet/leaflet.css" />
<script src="static/leaflet/leaflet.js"></script>

<link rel="stylesheet" type="text/css" href="static/datatables.css">
<script type="text/javascript" charset="utf8" src="static/datatables.js"></script>
<script src="/gstatic/codemirror/mode/javascript/javascript.js"></script>
<script>
    $(document).ready( function () {
		try 
			{	
			$('#items_table').DataTable( {
				"paging": false,
				fixedHeader: true
				} );				
			}
		catch (e) 
			{
			console.log("Datatable JS not loaded, showing standard table without reorder option")
			}

		var map = L.map('detail_map').setView([{{ p._lat }}, {{ p._lon }}], 8);

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		L.marker([{{ p._lat }}, {{ p._lon }}]).addTo(map);

		$('#test_match_string').click(function() {
			$.get('test_match_string', $.param({match_string:  $('#owm_string_source').val()}), function(match_string_eval_result) {
				console.log(match_string_eval_result);
				parsed_result = JSON.parse(match_string_eval_result);
				$('#result_output').empty();
				$('#result_output').append("<div>" + (parsed_result.success ? '<img src="static/img/lamp_green.png" alt="{{ _('Erfolg') }}" style="width: 17px;padding-bottom: 3px;"/>' : '<img src="static/img/lamp_red.png" alt="{{ _('Fehler') }}" style="width: 17px;padding-bottom: 3px;"/>') + parsed_result.value + "</div>");
				$('#result_output').append("<div>{{ _('Gehe zu Datenquelle') }}: " + parsed_result.queried_source + " / {{ _('Pfad in der Datenquelle') }}: " + parsed_result.path_in_source + "</div>");
				// alert("owm_block_" + parsed_result.queried_source.replace('-', '_minus_') + "_nav");
			});
		});
	});

	function togglevis(id) {
		var div = document.getElementById(id);
		div.style.display = div.style.display == "none" ? "block" : "none";
	}
</script>
<style>
	.owm_codeblock {
		display: none;
	}
	.owm_exampleblock {
		display: none;
	}

	.owm_c_active {
		display: block;
	}

	.owm_e_active {
		display: block;
	}

	.owm_c_nav_active {
		font-weight: bold;
	}

	.owm_e_nav_active {
		font-weight: bold;
	}

	.owm_codeblock textarea {
		display: none;
	}

	.owm_nav_box {
		border-width: 1px;
		border-style: solid;
		border-color: #ddd;
		width: 210px;
		background: #ddd;
		padding: 3px;
		margin-bottom: 3px;
		cursor: pointer;
	}

	.owm_nav_box:hover {
		border-color: red;
	}

	.clickable {
		cursor: pointer;
	}
</style>
<script language="javascript">
	function enable_block(block) {
		$(".owm_c_active").toggleClass("owm_c_active");
		$(".owm_c_nav_active").toggleClass("owm_c_nav_active");
		block.toggleClass("owm_c_nav_active");
		
		selected_block = "#" + block.attr("id").replace('_nav', '');
		$(selected_block).toggleClass("owm_c_active");

		src_origin = selected_block + " textarea";
		window.bodytab2_json_editor.setValue($(src_origin).val());
	}

	function enable_example(block) {
		$(".owm_e_active").toggleClass("owm_e_active");
		$(".owm_e_nav_active").toggleClass("owm_e_nav_active");
		block.toggleClass("owm_e_nav_active");
		
		selected_block = "#" + block.attr("id").replace('_nav', '');
		$(selected_block).toggleClass("owm_e_active");
	}

	$(function() {
		$(".owm_codeblock").each(function( index ) {
			$("#"+$(this).attr("id")+'_nav').click(function() {
				enable_block($(this));
			});
		});

		enable_block($("#code_nav .owm_nav_box").first());
	});

	$(function() {
		$(".owm_exampleblock").each(function( index ) {
			$("#"+$(this).attr("id")+'_nav').click(function() {
				enable_example($(this));
			});
		});

		enable_example($("#example_nav .owm_nav_box").first());
	});
</script>

{% endblock pluginscripts %}

{% block headtable %}
<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<td class="py-1 clickable" onClick="togglevis('detail_map')" width="150px"><strong>{{ _('Breitengrad') }}</strong></td>
			<td class="py-1 clickable" onClick="togglevis('detail_map')">{{ p._lat }}</td>
			<td class="py-1" width="150px"><strong>{{ _('Sprache') }}</strong></td>
			<td class="py-1">{{ p._lang }}</td>
		</tr>
		<tr>
			<td class="py-1 clickable" onClick="togglevis('detail_map')" width="150px"><strong>{{ _('Längengrad') }}</strong></td>
			<td class="py-1 clickable" onClick="togglevis('detail_map')">{{ p._lon }}</td>
			<td class="py-1" width="150px"><strong>{{ _('Einheiten') }}</strong></td>
			<td class="py-1">{{ p._units }}</td>
		</tr>
		<tr>
			<td class="py-1 clickable" onClick="togglevis('detail_map')" width="150px"><strong>{{ _('Höhe in m') }}</strong></td>
			<td class="py-1 clickable" onClick="togglevis('detail_map')" class="">{{ p._elev }}</td>
			<td class="py-1" width="150px"><strong>{{ _('Ladezyklus (s)') }}</strong></td>
			<td class="py-1">{{ p._cycle }}</td>
		</tr>
		<tr>
			<td class="py-1" width="150px"><strong>{{ _('API-Schlüssel') }}</strong></td>
			<td class="py-1" colspan="3"><div title="{{ p._key }}">{% for letter in p._key %}*{% endfor %}</div></td>
		</tr>
	</tbody>
</table>
<div id="detail_map" style="position:fixed;bottom:10px;right: 5%;width:50%; height: 50%; display:none" class="mb-2 alert alert-success alert-dismissible fade show" role="alert"></div>
{% endblock headtable %}

{% block bodytab1 %}
<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
	<div class="col-sm-12">
		<h5>{{ _('Items with relation to this OWM-plugin instance') }} ({{ item_data|length }})</h5>

		<table class="table table-striped table-hover pluginList" id="items_table">
			<thead>
				<tr class="shng_heading">
					<th>{{ _('Pfad') }}</th>
					<th>{{ _('Typ') }}</th>
					<th>owm_matchstring</th>
					<th>{{ _('Wert') }}</th>
					<th>{{ _('Letztes Update') }}</th>
					<th>{{ _('Letzter Change') }}</th>
				</tr>
			</thead>
			<tbody>
				{% for key, item in item_data.items() %}
					<tr id="{{ loop.index }}_click">
						<td class="py-1">{{ item[1].property.path }}</td>
						<td class="py-1">{{ item[1].property.type }}</td>
						<td class="py-1">{{ item[0] }}</td>
						<td class="py-1">{% if key in ['precipitation_new', 'clouds_new', 'pressure_new', 'wind_new', 'temp_new'] %}<a class="text-shng" target="_blank" href="{{ item() }}">{{ item[1]() }}</a>{% else %} {{ item[1]() }} {% endif %}</td>
						<td class="py-1">{{ item[1].property.last_update.strftime('%d.%m.%Y %H:%M:%S') }}<br />{{ item[1].property.last_update_by }}</td>
						<td class="py-1">{{ item[1].property.last_change.strftime('%d.%m.%Y %H:%M:%S') }}</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
{% endblock %}

{% block bodytab2 %}
<br style="clear:both;"/>
<div style="float: left; width: 220px; display: block;" id="code_nav">
	{% for data_source in json_data %}
		<div class="owm_nav_box code" id="owm_block_{{ data_source.key }}_nav">{{ data_source.key | replace('_minus_', '-') }}</div>
	{% endfor %}
</div>

{% for data_source in json_data %}
	<div class="owm_codeblock code" id="owm_block_{{ data_source.key }}">
		<h5>{{ data_source.key | replace('_minus_', '-') }}</h5>
		<table>
			<tr>
				<td>{{ _('Origin') }}:</td>
				<td><a href="{{ data_source.url }}">{{ data_source.url | replace(p._key, "(key)") }}</a></td>
			</tr>
			<tr>
				<td>{{ _('Fetched') }}: &nbsp; </td>
				<td>{{ data_source.fetched }}</td>
			</tr>
		</table>
		<textarea autocomplete="off">{{ data_source.data }}</textarea>
	</div>
{% endfor %}

<div style="margin-bottom: 10px; margin-top: 10px;">
	<textarea autocomplete="off" id="bodytab2_editor"></textarea>
</div>
<script type="text/javascript" language="javascript">
	window.bodytab2_json_editor = CodeMirror.fromTextArea(document.getElementById("bodytab2_editor"), {
		mode: {name: "javascript", json: true},
		lineNumbers: true,
		readOnly: true,
		lineWrapping: true,
		extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
		foldGutter: true,
		gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
	});
	window.bodytab2_json_editor.refresh();
</script>
{% endblock %}

{% block bodytab3 %}
<div style="width: 100%;">
	<input type="text" name="owm_string_source" id="owm_string_source"></input>
	<button type="button" class="btn btn-shng btn-sm" id="test_match_string">Testen</button>
	<div id="result_output"></div>
</div>
<br style="clear:both;"/>
<div style="float: left; width: 220px; display: block;" id="example_nav">
	<div class="owm_nav_box" id="owm_block_exampl_rain_nav">Regen</div>
	<div class="owm_nav_box" id="owm_block_exampl_temp_nav">Temperaturen</div>
</div>
<div id="owm_block_exampl_rain" class="owm_exampleblock">
	<h5>Regen</h5>
	Und seine Freunde	
</div>
<div id="owm_block_exampl_temp" class="owm_exampleblock">
	<h5>Temperaturen</h5>
	Und deren Freunde	
</div>
{% endblock %}



{% block buttons %}
<button type="button" class="btn btn-shng btn-sm" onclick="if (confirm('{{ _('Sollen nun einmalig alle Dateien abgefragt werden?') }}')) { jQuery.get('force_download_all',  function( data ) { location.reload(); }); }">{{ _('Alle Dateien herunterladen') }}</button>
{% endblock %}