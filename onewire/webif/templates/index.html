{% extends "base_plugin.html" %}

{% set logo_frame = false %}

<!-- set update_interval to a value > 0 (in milliseconds) to enable periodic data updates -->
{% set update_interval = 0 %}

{% block pluginstyles %}
<style>
  .type {
    width: 50px;
  }
  .sensor {
    width: 160px;
  }
  .deviceclass {
    width: 130px;
  }
  .devicetype {
    width: 130px;
  }
  .value {
      text-align:right;
	  width: 120px;
  }
  .value {
      text-align:right;
	  width: 120px;
  }
  .change_update {
    width: 150px;
  }
  .bus {
    width: 60px;
  }
  .bool {
    width: 70px;
  }
  .keys {
    min-width: 240px;
  }
</style>
{% endblock pluginstyles %}
<!--
	Additional script tag for plugin specific javascript code go into this block
-->
{% block pluginscripts %}
<script>
  $(document).ready( function () {
    $(window).trigger('datatables_defaults');
    try {
      {% if webif_pagelength is defined %}webif_pagelength = {{ webif_pagelength|int }};{% endif %}
      if (isNaN(parseFloat(webif_pagelength)) || webif_pagelength == 0) {
        resize = true;
        webif_pagelength = -1;
		  console.log('Activating automatic table resize');
      }
      else {
        resize = false;
      }
    }
    catch (e) {
      webif_pagelength = 100;
      resize = false;
      console.log("Using default values for page length " + webif_pagelength + ", pageResize: " + resize);
    }
		try {
      table1 = $('#maintable').DataTable( {
        columnDefs: [
			{ "targets": [2], "className": "type"},
			{ "targets": [3], "className": "sensor"},
			{ "targets": [4], "className": "deviceclass"},
			{ "targets": [5], "className": "value" },
			{ "targets": [6,7], "className": "change_update"}
		].concat($.fn.dataTable.defaults.columnDefs),
        pageLength: webif_pagelength,
        pageResize: resize});
      table2 = $('#bustable').DataTable( {
        columnDefs: [
			{ "targets": [1], "className": "sensor"},
			{ "targets": [2], "className": "bus"},
			{ "targets": [3], "className": "deviceclass"},
			{ "targets": [4], "className": "devicetype"},
			{ "targets": [5], "className": "bool"},
			{ "targets": [6], "className": "keys"}
		].concat($.fn.dataTable.defaults.columnDefs),
        pageLength: webif_pagelength,
        pageResize: resize});
		}
		catch (e) {
			console.warn("Datatable JS not loaded, showing standard table without reorder option " +e);
    }

  });
</script>
<script>
	function handleUpdatedData(response, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			var objResponse = JSON.parse(response);
			myProto = document.getElementById(dataSet);
			for (var item in objResponse['item_values']) {
				shngInsertText (item+'_value', objResponse['item_values'][item]['value'], 'maintable', 10);
				shngInsertText (item+'_last_update', objResponse['item_values'][item]['last_update'], 'maintable', 10);
				shngInsertText (item+'_last_change', objResponse['item_values'][item]['last_change'], 'maintable', 10);
			}
			shngInsertText ('broker_uptime', objResponse['broker_uptime']);

			shngInsertText ('msg_rcv_1min', objResponse['broker_info']['msg_rcv_1min'], 'bustable', 1);
			shngInsertText ('msg_rcv_5min', objResponse['broker_info']['msg_rcv_5min'], 'bustable', 1);
			shngInsertText ('msg_rcv_15min', objResponse['broker_info']['msg_rcv_15min'], 'bustable', 1);
			shngInsertText ('msg_snt_1min', objResponse['broker_info']['msg_snt_1min'], 'bustable', 1);
			shngInsertText ('msg_snt_5min', objResponse['broker_info']['msg_snt_5min'], 'bustable', 1);
			shngInsertText ('msg_snt_15min', objResponse['broker_info']['msg_snt_15min'], 'bustable', 1);

		}

	}
</script>

<!--
<script>
	function handleUpdatedData(response, dataSet=null) {
		if (dataSet === 'devices_info' || dataSet === null) {
			var objResponse = JSON.parse(response);
			myProto = document.getElementById(dataSet);
			for (var device in objResponse) {
				< !--
				shngInsertText (device+'_source', objResponse[device]['source']);
				shngInsertText (device+'_powerState', objResponse[device]['powerState']);
				-- >
			}
		}
	}
</script>
-->
{% endblock pluginscripts %}


{% block headtable %}
<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<td class="py-1"><strong>{{ _('Host') }}</strong></td>
			<td class="py-1">{{ p.host }}</td>
			<td class="py-1" width="50px"></td>
			<td class="py-1"><strong>{{ _('IO Wartezeit') }}</strong></td>
			<td class="py-1">{{ p._io_wait }}</td>
			<td class="py-1" width="50px"></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Port') }}</strong></td>
			<td class="py-1">{{ p.port }}</td>
			<td></td>
			<td class="py-1"><strong>{{ _('iButton Wartezeit') }}</strong></td>
			<td class="py-1">{{ p._button_wait }}</td>
			<td></td>
		</tr>
		<tr>
			<td class="py-1"><strong>{{ _('Cycle') }}</strong></td>
			<td class="py-1">{{ p._cycle }}</td>
			<td></td>
			<!--
			<td class="py-1"><strong>{{ _('Alias verwenden') }}</strong></td>
			<td class="py-1">{{ p._use_ow_aliases }}</td>
			-->
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</tbody>
</table>
{% endblock headtable %}


<!--
	Additional buttons for the web interface (if any are needed) - displayed below the headtable-section
-->
{% block buttons %}
{% if 1==2 %}
	<div>
		<button id="btn1" class="btn btn-shng btn-sm" name="scan" onclick="shngPost('', {learn: 'on'})"><i class="fas fa-question"></i>&nbsp;&nbsp;&nbsp;{{ _('nach Devices suchen') }}&nbsp;</button>
	</div>
{% endif %}
{% endblock %}
<!--
	Define the number of tabs for the body of the web interface (1 - 3)
-->
{% set tabcount = 2 %}
{% set start_tab = 1 %}

<!--
	Content block for the first tab of the Webinterface
-->
{% set tab1title = "<strong>" ~ p.get_shortname() ~ " " ~ _(('Items')) ~ "</strong> (" ~ p._plg_item_dict|length ~ ")" %}

{% block bodytab1 %}

<div class="container-fluid m-2 table-resize">
	<div><strong>{{ _('Geräte in Items') }}:</strong> {{ p._sensors|length }} {{ _('Sensoradresse(n)') }}, {{ p._ios|length }} {{ _('IO Gerätadresse(n)') }}, {{ p._ibuttons|length }} {{ _('iButtonadresse(n)') }}</div>

	<table id="maintable">
		<thead>
		<tr><th></th>
			<th>{{ _('Item') }}</th>
			<th>Typ</th>
			<th>{{ _('Sensor') }}</th>
			<th>{{ _('Geräteklasse') }}</th>
			<th class="dt-head-right" >{{ _('Wert') }}</th>
			<th>{{ _('Letztes Update') }}</th>
			<th>{{ _('Letzte Änderung') }}</th>
		</tr>
		</thead>

		{% for item in p.get_item_list() %}
			<tr><td></td>
				<td>{{ item.id() }}</td>
				<td>{{ item.type() }}</td>

				{% if (p.get_item_config(item)['sensor_addr'] in p._buses['bus.0']) or (p.get_item_config(item)['sensor_addr'] in p._buses['bus.1']) or (p.get_item_config(item)['sensor_addr'] in p._buses['bus.2']) %}
					<td>{{ p.get_item_config(item)['sensor_addr'] }}</td>
					<td>{{ p.get_item_config(item)['deviceclass'] }}</td>
					<td>{{ item() }} {{ p.get_item_config(item)['unit'] }}</td>
				{% else %}
					<td style="color:indianred">{{ p.get_item_config(item)['sensor_addr'] }}</td>
					<td style="color:indianred">{{ p.get_item_config(item)['deviceclass'] }}</td>
					<td style="color:indianred">{{ item() }}</td>
				{% endif %}

				<td>{{ item.property.last_update.strftime('%d.%m.%Y %H:%M:%S') }}</td>
				<td>{{ item.property.last_change.strftime('%d.%m.%Y %H:%M:%S') }}</td>
			</tr>
		{% endfor %}

	</table>
</div>

{% endblock bodytab1 %}


<!--
	Content block for the second tab of the Webinterface
-->
{% if p._buses|length > 1 %}
	{% set tab2title = "<strong>" ~ p.get_shortname() ~ " " ~ _('Busse') ~ "</strong> (" ~ p._buses|length ~ ")" %}
{% else %}
	{% set tab2title = "<strong>" ~ p.get_shortname() ~ " " ~ _('Bus') ~ "</strong>" %}
{% endif %}

{% block bodytab2 %}

<div class="container-fluid m-2 table-resize">

	{% if p._buses|length > 2 %}
		<div><strong>bus.0</strong>: {{ p._webif_buses['bus.0']|length }} {{ _('Gerät(e)') }}, <strong>bus.1</strong>: {{ p._webif_buses['bus.1']|length }} {{ _('Gerät(e)') }}, <strong>bus.2</strong>: {{ p._webif_buses['bus.2']|length }} {{ _('Gerät(e)') }}</div>
	{% elif p._buses|length > 1 %}
		<div><strong>bus.0</strong>: {{ p._webif_buses['bus.0']|length }} {{ _('Gerät(e)') }}, <strong>bus.1</strong>: {{ p._webif_buses['bus.1']|length }} {{ _('Gerät(e)') }}</div>
	{% else %}
		<div><strong>bus.0</strong>: {{ p._webif_buses['bus.0']|length }} {{ _('Gerät(e)') }}</div>
	{% endif %}

	<table id="bustable">
		<thead>
		<tr><th></th>
			<th>{{ _('Device') }}</th>
			<th>{{ _('Bus') }}</th>
			<th>{{ _('Geräteklasse') }}</th>
			<th>{{ _('Devicetyp') }}</th>
			<th>{{ _('Items definiert') }}</th>
			<th>{{ _('Keys') }}</th>
		</tr>
		</thead>

	{% for bus in p._buses %}
		{% for device in p._webif_buses[bus] %}
				<tr><td></td>
					<td>{{ device }}</td>
					<td>{{ bus }}</td>
					<td>{{ p._webif_buses[bus][device]['deviceclass'] }}</td>
					<td>{{ p._webif_buses[bus][device]['devicetype'] }}</td>
<!--
					{ % if len(p.get_item_list_for_command(device)) > 0 % }
						<td>{{ _('Ja') }}</td>
					{ % else % }
						<td>{{ _('Nein') }}</td>
					{ % endif % }
-->
					{% if p.count_items_for_device(device) > 0 %}
						<td>{{ p.count_items_for_device(device) }}</td>
					{% else %}
						<td>{{ _('Nein') }}</td>
					{% endif %}
					<td>{{ p._webif_buses[bus][device]['keys'] }}</td>
				</tr>
			{% endfor %}
		{% endfor %}

	</table>
</div>

{% endblock bodytab2 %}
