{% extends "base_plugin.html" %}

{% set logo_frame = false %}
{% set use_bodytabs = true %}
{% set tabcount = 2 %}
{% set tab1title = 'Items' %}
{% set tab2title = 'JSON Data' %}

{% set start_tab = 2 %}

{% set json_data = p._get_all_data_for_webif() %}
{% set item_data = p._items %}

{% block headtable %}
<script src="/gstatic/codemirror/mode/javascript/javascript.js"></script>
<style>
	.owm_codeblock {
		display: none;
	}

	.owm_active {
		display: block;
	}

	.owm_nav_active {
		font-weight: bold;
	}

	.owm_codeblock textarea {
		display: none;
	}

	.owm_nav_box {
		border-width: 1px;
		border-style: solid;
		border-color: #ddd;
		width: 210px;
		background: #ddd;
		padding: 3px;
		margin-bottom: 3px;
		cursor: pointer;
	}

	.owm_nav_box:hover {
		border-color: red;
	}
</style>
<script language="javascript">
	function enable_block(block) {
		$(".owm_active").toggleClass("owm_active");
		$(".owm_nav_active").toggleClass("owm_nav_active");
		block.toggleClass("owm_nav_active");
		
		selected_block = "#" + block.attr("id").replace('_nav', '');
		$(selected_block).toggleClass("owm_active");
		src_origin = selected_block + " textarea";
		window.bodytab2_json_editor.setValue($(src_origin).val());
	}

	$(function() {
		$(".owm_codeblock").each(function( index ) {
			$("#"+$(this).attr("id")+'_nav').click(function() {
				enable_block($(this));
			});
		});

		enable_block($(".owm_nav_box").first());
	});
</script>
{% endblock %}

{% block bodytab1 %}
<div class="table-responsive" style="margin-left: 2px; margin-right: 2px;" class="row">
	<div class="col-sm-12">
		<h5>OpenWeatherMap Plugin Items ({{ item_data|length }})</h5>

		<table class="table table-striped table-hover pluginList">
			<thead>
				<tr class="shng_heading">
					<th>Pfad</th>
					<th>Typ</th>
					<th>owm_matchstring</th>
					<th>Wert</th>
					<th>Letztes Update</th>
					<th>Letzter Change</th>
				</tr>
			</thead>
			<tbody>
				{% for key, item in item_data.items() %}
					<tr id="{{ loop.index }}_click">
						<td class="py-1">{{ item[1].property.path }}</td>
						<td class="py-1">{{ item[1].property.type }}</td>
						<td class="py-1">{{ item[0] }}</td>
						<td class="py-1">{% if key in ['precipitation_new', 'clouds_new', 'pressure_new', 'wind_new', 'temp_new'] %}<a class="text-shng" target="_blank" href="{{ item() }}">{{ item[1]() }}</a>{% else %} {{ item[1]() }} {% endif %}</td>
						<td class="py-1">{{ item[1].property.last_update.strftime('%d.%m.%Y %H:%M:%S') }}<br />{{ item[1].property.last_update_by }}</td>
						<td class="py-1">{{ item[1].property.last_change.strftime('%d.%m.%Y %H:%M:%S') }}</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>
{% endblock %}

{% block bodytab2 %}
<br style="clear:both;"/>
<div style="float: left; width: 220px; display: block;">
	{% for data_source in json_data %}
		<div class="owm_nav_box" id="owm_block_{{ data_source.key }}_nav">{{ data_source.key | replace('_minus_', '-') }}</div>
	{% endfor %}
</div>

{% for data_source in json_data %}
	<div class="owm_codeblock" id="owm_block_{{ data_source.key }}">
		<h5>{{ data_source.key | replace('_minus_', '-') }}</h5>
		<table>
			<tr>
				<td>Origin:</td>
				<td><a href="{{ data_source.url }}">{{ data_source.url | replace(p._key, "(key)") }}</a></td>
			</tr>
			<tr>
				<td>Fetched: &nbsp; </td>
				<td>{{ data_source.fetched }}</td>
			</tr>
		</table>
		<textarea autocomplete="off">{{ data_source.data }}</textarea>
	</div>
{% endfor %}

<div style="margin-bottom: 10px; margin-top: 10px;">
	<textarea autocomplete="off" id="bodytab2_editor"></textarea>
</div>
<script type="text/javascript" language="javascript">
	window.bodytab2_json_editor = CodeMirror.fromTextArea(document.getElementById("bodytab2_editor"), {
		mode: {name: "javascript", json: true},
		lineNumbers: true,
		readOnly: true,
		lineWrapping: true,
		extraKeys: {"Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); }},
		foldGutter: true,
		gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
	});
	window.bodytab2_json_editor.refresh();
</script>
{% endblock %}